<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>PNW Moths</title>
    <link rel="stylesheet" href="moths.css" type="text/css" />
    <script src="jquery.js" type="text/javascript"></script>
    <script src="jquery.csv.js" type="text/javascript"></script>
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAA_cr19ifAS821S0ocdvCL1BTEt7yEbW0t6wBwzgPUvU4EFci-WRRknm1HoToMnoOol-K1r4PFdPBLfg"
      type="text/javascript"></script>
    <script src="http://gmaps-utility-library.googlecode.com/svn/trunk/markermanager/release/src/markermanager.js"></script>
    <script type="text/javascript">
    //<![CDATA[
    var map;
    var mgr;
    var markers;
    
    // List of available species based on data in CSV.
    var unique_species;
    
    // Column names and index values for data loaded from CSV.
    var c = {"genus": 2,
             "species": 3,
             "lat": 5,
             "lng": 4,
             "state": 6,
             "county": 7,
             "city": 8,
             "elevation": 9,
             "elevation_units": 10,
             "year": 11};

    // TODO: Define all filters that can be applied.

    // Dynamic list of filters to be applied to the data set at any given time.
    var filters = [["year", 1900, 1960]];

    var simpleIcon = new GIcon(G_DEFAULT_ICON);
    simpleIcon.image = "icon.png";
    simpleIcon.shadow = "icon.png";
    simpleIcon.iconSize = new GSize(10, 10);
    simpleIcon.shadowSize = new GSize(10, 10);
    simpleIcon.iconAnchor = new GPoint(8, 8);
    simpleIcon.infoWindowAnchor = new GPoint(8, 8);
    markerOptions = { icon:simpleIcon }
    
    function createMarker(point, number, html) {
      var marker = new GMarker(point, markerOptions);
      marker.value = number;
      
      GEvent.addListener(marker, "click", function() {
        map.openInfoWindowHtml(point, html);
      });
      return marker;
    }

    function createSpeciesName(marker) {
      if (!marker[c.genus] || !marker[c.species]) {
        return "";
      }
      
      return jQuery.trim(marker[c.genus]) + " " + jQuery.trim(marker[c.species]);
    }

    function addTerritoryBoundaries() {
      // Place a polygon around the area we're most interested in.
      var polygon = new GPolygon([
            new GLatLng(40, -109.5),
            new GLatLng(53, -109.5),
            new GLatLng(53, -126),
            new GLatLng(40, -126),
            new GLatLng(40, -109.5)
		  ], "#0099ff", 2, 1, "#ccffff", 0.2);
		  map.addOverlay(polygon);
		}

    function populateMapBySpecies(species) {
      mgr.clearMarkers();
      var species_markers = [];
      
      for (var i = 0; i < markers.length; i++) {
        var species_name = createSpeciesName(markers[i]);

        // If a species filter is set, don't display any species other than 
        // the requested.
        if (species != species_name) {
          continue;
        }
        
        // Apply filters.
        var filters_match = true;
        for (filter_index in filters) {
          var filter = filters[filter_index];
          var attribute = filter[0];
          var startkey = filter[1];
          var endkey = filter[2];
          var value = markers[i][c[attribute]];
          if (value < startkey || value >= endkey) {
            filters_match = false;
            break;
          }
        }
        
        if (!filters_match) {
          continue;
        }
          
        // Create a new point for the marker and use any existing information
        // to build a description for the information window.
        var point = new GLatLng(parseFloat(markers[i][c.lat]),
                                parseFloat(markers[i][c.lng]));
        var description = "<table><tr><th colspan='2'>" + species_name + "</th></tr>";
        description += "<tr><td>City/Site:</td><td>" + markers[i][c.city] + "</td></tr>";
        description += "<tr><td>County:</td><td>" + markers[i][c.county] + "</td></tr>";
        description += "<tr><td>State:</td><td>" + markers[i][c.state] + "</td></tr>";
        description += "<tr><td>Year:</td><td>" + markers[i][c.year] + "</td></tr>";
        description += "<tr><td>Elevation:</td><td>" + markers[i][c.elevation] + " " + markers[i][c.elevation_units] + "</td></tr>";
        description += "</table>";
        species_markers.push(createMarker(point, i, description));
      }
      
      mgr.addMarkers(species_markers, 3, 10);
      mgr.refresh();
      
      return false;
    }

    function load() {
      if (!GBrowserIsCompatible()) {
        return;
      }

      map = new GMap2(document.getElementById("map"));
      // Center on Washington State.
      map.setCenter(new GLatLng(46.60, -118.00), 5);
      map.addControl(new GLargeMapControl());
      map.addControl(new GMapTypeControl());
      map.addMapType(G_PHYSICAL_MAP);
      map.setMapType(G_PHYSICAL_MAP);
      addTerritoryBoundaries();
      
      mgr = new MarkerManager(map);

      GDownloadUrl("moths.csv", function(data, responseCode) {
        markers = jQuery.csv(",", "\"", "\n")(data);
        unique_species = new Array();

        for (var i = 0; i < markers.length; i++) {
          var species_name = createSpeciesName(markers[i]);

          // Add this species to the list of unique species if it hasn't been 
          // counted already.  This is done before filtering to get a complete
          // list even when a filter is applied.
          if (species_name != "" && 
              jQuery.inArray(species_name, unique_species) == -1) {
            unique_species.push(species_name);
          }
        }

        // Create a filter list for each unique species.
        var filter_list = "<ul>";
        for (i in unique_species) {
          filter_list += "<li><a href='#' onclick=\"populateMapBySpecies('"
          filter_list += unique_species[i] + "');\">"
          filter_list += unique_species[i] + "</a></li>";
        }
        filter_list += "</ul>";
        $("#filter").html(filter_list);
      });
    }
    //]]>
    </script>
  </head>
  <body onload="load()" onunload="GUnload()">
    <div id="map"></div>
    <div id="filter"></div>
  </body>
</html>
