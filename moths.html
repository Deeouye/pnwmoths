<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>PNW Moths</title>
    <link rel="stylesheet" href="moths.css" type="text/css" />
    <script src="jquery.js" type="text/javascript"></script>
    <script src="jquery.csv.js" type="text/javascript"></script>
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAA_cr19ifAS821S0ocdvCL1BTEt7yEbW0t6wBwzgPUvU4EFci-WRRknm1HoToMnoOol-K1r4PFdPBLfg"
      type="text/javascript"></script>
    <script src="http://gmaps-utility-library.googlecode.com/svn/trunk/markermanager/release/src/markermanager.js"></script>
    <script type="text/javascript">
    //<![CDATA[
    var map;
    var mgr;
    var markers;
    var selected_species;

    var simple_icon = new GIcon(G_DEFAULT_ICON);
    simple_icon.image = "icon.png";
    simple_icon.shadow = "icon.png";
    simple_icon.iconSize = new GSize(10, 10);
    simple_icon.shadowSize = new GSize(10, 10);
    simple_icon.iconAnchor = new GPoint(8, 8);
    simple_icon.infoWindowAnchor = new GPoint(8, 8);
    marker_options = { icon:simple_icon }

    // List of available species based on data in CSV.
    var unique_species;

    // Column names and index values for data loaded from CSV.
    var c = {"genus": 2,
             "species": 3,
             "lat": 5,
             "lng": 4,
             "state": 6,
             "county": 7,
             "city": 8,
             "elevation": 9,
             "elevation_units": 10,
             "year": 11,
             "month": 12};

    // All filters that can be applied to data set.
    var all_filters = {"elevation": {"title": "Elevation (ft.)",
                                     "help_text": "(e.g., 2000-4000)"},
                       "month": {"title": "Month",
                                 "help_text": "(e.g., 1 for January, 8 for August)"},
                       "year": {"title": "Year",
                                "help_text": "(e.g., 1945-1965)"}};

    // Dynamic set of filters to be applied to the data set at any given time.
    var filters = {};

    function setFilter(key, startkey, endkey) {
      filters[key] = [startkey, endkey];

      if (selected_species) {
        populateMapBySpecies(selected_species);
      }
      return false;
    }

    function removeFilter(key) {
      if (filters[key]) {
        delete filters[key];
      }

      if (selected_species) {
        populateMapBySpecies(selected_species);
      }
      return false;
    }

    function clearFilters() {
      filters = {};

      if (selected_species) {
        populateMapBySpecies(selected_species);
      }
      return false;
    }

    function createMarker(point, number, html) {
      var marker = new GMarker(point, marker_options);
      marker.value = number;

      GEvent.addListener(marker, "click", function() {
        map.openInfoWindowHtml(point, html);
      });
      return marker;
    }

    function createSpeciesName(marker) {
      if (!marker[c.genus] || !marker[c.species]) {
        return "";
      }

      return jQuery.trim(marker[c.genus]) + " " + jQuery.trim(marker[c.species]);
    }

    function addTerritoryBoundaries() {
      // Place a polygon around the area we're most interested in.
      var polygon = new GPolygon([
            new GLatLng(40, -109.5),
            new GLatLng(53, -109.5),
            new GLatLng(53, -126),
            new GLatLng(40, -126),
            new GLatLng(40, -109.5)
		  ], "#0099ff", 2, 1, "#ccffff", 0.2);
		  map.addOverlay(polygon);
		}

    function populateMapBySpecies(species) {
      selected_species = species;
      mgr.clearMarkers();
      var species_markers = [];
      var sites = {};

      // Build a set of unique latitude/longitude sites with a marker and a 
      // digest of each site's description.
      for (var i = 0; i < markers.length; i++) {
        var species_name = createSpeciesName(markers[i]);

        // If a species filter is set, don't display any species other than 
        // the requested.
        if (species != species_name) {
          continue;
        }

        // Apply filters.
        var filters_match = true;
        for (key in filters) {
          var startkey = filters[key][0];
          var endkey = filters[key][1];
          var value = markers[i][c[key]];
          if (value < startkey || value > endkey) {
            filters_match = false;
            break;
          }
        }

        if (!filters_match) {
          continue;
        }

        // If this is the first unfiltered instance of this site, create the 
        // site marker and start the description string.
        var site = [markers[i][c.lat], markers[i][c.lng]];
        if (!sites[site]) {
          var point = new GLatLng(parseFloat(markers[i][c.lat]),
                                  parseFloat(markers[i][c.lng]));
          sites[site] = {"marker": point,
                         "description": ""};
        }

        var description = "<table><tr><th colspan='2'>" + species_name + "</th></tr>";
        description += "<tr><td>City/Site:</td><td>" + markers[i][c.city] + "</td></tr>";
        description += "<tr><td>County:</td><td>" + markers[i][c.county] + "</td></tr>";
        description += "<tr><td>State:</td><td>" + markers[i][c.state] + "</td></tr>";
        description += "<tr><td>Elevation:</td><td>" + markers[i][c.elevation] + " " + markers[i][c.elevation_units] + "</td></tr>";        
        description += "<tr><td>Year:</td><td>" + markers[i][c.year] + "</td></tr>";
        description += "<tr><td>Month:</td><td>" + markers[i][c.month] + "</td></tr>";
        description += "</table>";
        sites[site].description += description;
      }

      // Add markers for each unique site.
      var i = 0;
      for (site in sites) {
        var point = sites[site].point;
        var description = sites[site].description;
        species_markers.push(createMarker(point, i, description));
        i++;
      }

      mgr.addMarkers(species_markers, 3, 10);
      mgr.refresh();

      return false;
    }

    function castStringToInt(value) {
      if (value && value.length > 0) {
        return parseInt(value);
      }
      
      return "";
    }

    function convertMetersToFeet(meters) {
      return parseInt(meters * 3.2808399);
    }

    function load() {
      if (!GBrowserIsCompatible()) {
        return;
      }

      map = new GMap2(document.getElementById("map"));

      // Center on Washington State.
      map.setCenter(new GLatLng(46.90, -118.00), 5);
      map.addControl(new GLargeMapControl());
      map.addControl(new GMapTypeControl());
      map.addMapType(G_PHYSICAL_MAP);
      map.setMapType(G_PHYSICAL_MAP);
      addTerritoryBoundaries();

      // Setup manager to control the zoom levels at which markers are displayed.
      mgr = new MarkerManager(map);

      GDownloadUrl("moths.csv", function(data, responseCode) {
        markers = jQuery.csv(",", "\"", "\n")(data);
        unique_species = new Array();

        for (var i = 0; i < markers.length; i++) {
          var species_name = createSpeciesName(markers[i]);

          // Add this species to the list of unique species if it hasn't been 
          // counted already.  This is done before filtering to get a complete
          // list even when a filter is applied.
          if (species_name != "" && 
              jQuery.inArray(species_name, unique_species) == -1) {
            unique_species.push(species_name);
          }

          // Cast integer and float fields.
          markers[i][c.elevation] = castStringToInt(markers[i][c.elevation]);
          markers[i][c.year] = castStringToInt(markers[i][c.year]);
          markers[i][c.month] = castStringToInt(markers[i][c.month]);
          
          // Convert fields with meter measurements to feet measurements.
          if (/^m/.exec(markers[i][c.elevation_units])) {
            markers[i][c.elevation] = convertMetersToFeet(markers[i][c.elevation]);
            markers[i][c.elevation_units] = "ft.";
          }
        }

        // Display a list of the unique species.
        var species_ul = $("<ul></ul>");
        for (i in unique_species) {
          species_a = $("<a href='#'>" + unique_species[i] + "</a>");
          species_a.click(function () {
                            $(this).parent().parent().find(".selected").removeClass("selected");
                            $(this).addClass("selected");
                            populateMapBySpecies($(this).text());
                          });
          species_ul.append($("<li></li>").append(species_a));
        }
        $("#species").append(species_ul);

        // Display filters to be applied to the current data set.
        var filters_ul = $("<ul></ul>");
        
        // Add link to clear all filters.
        var filters_ul_a = $("<a href='#'>Clear filters</a>");
        filters_ul_a.click(function () {
                             $("#filters .selected").removeClass("selected");
                             $("#filters .all").addClass("selected");
                             clearFilters();
                           });
        filters_ul.append($("<li></li>").append(filters_ul_a));

        for (filter_index in all_filters) {
          var filter_set = all_filters[filter_index];
          // Store each filter in a nested list.
          var filters_ul_ul = $("<ul></ul>");

          // Add link to remove this specific filter.
          filters_ul_a = $("<a href='#' class='selected all'>All " + filter_index + "s</a>");
          filters_ul_a.attr("key", filter_index);
          filters_ul_a.click(function () {
                               $(this).parent().parent().find(".selected").removeClass("selected");
                               $(this).addClass("selected");
                               removeFilter($(this).attr("key"));
                             });
          filters_ul_ul.append($("<li></li>").append(filters_ul_a));

          // Add form for custom filter range.
          form = $("<form></form>");
          form.attr("name", filter_index);
          startkey_field = $("<input type='text' size='5' />");
          startkey_field.attr("name", "startkey");
          form.append(startkey_field);
          form.append(" - ");
          endkey_field = $("<input type='text' size='5' />");
          endkey_field.attr("name", "endkey");
          form.append(endkey_field);
          form.append($("<input type='submit' value='Filter' />"));
          if (filter_set.help_text) {
            form.append($("<br /><span class='help'>" + filter_set.help_text + "</span>"));
          }

          // Set function for applying the filter defined by this form.          
          form.submit(function() {
                        var inputs = $(this).children("input")
                        var key = this.name;
                        var startkey = inputs.val()
                        var endkey = inputs.next().val();
                        
                        // If the keys can be converted to integers they should
                        // be so filtering works as expected.
                        try {
                          startkey = parseInt(startkey);
                          endkey = parseInt(endkey);
                        }
                        catch (error) {
                        }
                        
                        $(this).parent().parent().find(".selected").removeClass("selected");
                        $(this).parent().addClass("selected");
                        setFilter(key, startkey, endkey);
                        return false;
                      });
          
          filters_ul_ul.append($("<li></li>").append(form));
          filters_ul.append($("<li>" + filter_set.title + "</li>").append(filters_ul_ul));
        }
        $("#filters").append(filters_ul);
      });
    }
    //]]>
    </script>
  </head>
  <body onload="load()" onunload="GUnload()">
    <div id="status"></div>
    <div id="map"></div>
    <div id="species"></div>
    <div id="filters"></div>
  </body>
</html>
