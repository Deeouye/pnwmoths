<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>PNW Moths</title>
    <link rel="stylesheet" href="moths.css" type="text/css" />
    <script src="jquery.js" type="text/javascript"></script>
    <script src="jquery.csv.js" type="text/javascript"></script>
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAA_cr19ifAS821S0ocdvCL1BTEt7yEbW0t6wBwzgPUvU4EFci-WRRknm1HoToMnoOol-K1r4PFdPBLfg"
      type="text/javascript"></script>
    <script src="http://gmaps-utility-library.googlecode.com/svn/trunk/markermanager/release/src/markermanager.js"></script>
    <script type="text/javascript">
    //<![CDATA[
    var map;
    var mgr;
    var markers;

    var simple_icon = new GIcon(G_DEFAULT_ICON);
    simple_icon.image = "icon.png";
    simple_icon.shadow = "icon.png";
    simple_icon.iconSize = new GSize(10, 10);
    simple_icon.shadowSize = new GSize(10, 10);
    simple_icon.iconAnchor = new GPoint(8, 8);
    simple_icon.infoWindowAnchor = new GPoint(8, 8);
    marker_options = { icon:simple_icon }

    // List of available species based on data in CSV.
    var unique_species;

    // Column names and index values for data loaded from CSV.
    var c = {"genus": 2,
             "species": 3,
             "lat": 5,
             "lng": 4,
             "state": 6,
             "county": 7,
             "city": 8,
             "elevation": 9,
             "elevation_units": 10,
             "year": 11};

    // All filters that can be applied to data set.
    var all_filters = {"year": [[1900, 1950],
                               [1950, 1960],
                               [1960, 1970],
                               [1970, 1980],
                               [1980, 1990],
                               [1990, 2000],
                               [2000, 2010]],
                       "elevation": [[0, 1000],
                                     [1000, 2000],
                                     [2000, 3000],
                                     [3000, 4000],
                                     [4000, 10000]]};

    // Dynamic set of filters to be applied to the data set at any given time.
    var filters = {};

    function setFilter(key, startkey, endkey) {
      filters[key] = [startkey, endkey];
      //alert(filters[key]);
      return false;
    }

    function removeFilter(key) {
      if (filters[key]) {
        delete filters[key];
      }
      //alert(filters[key]);
      return false;
    }

    function clearFilters() {
      filters = {};
      //alert(filters);
      return false;
    }

    function createMarker(point, number, html) {
      var marker = new GMarker(point, marker_options);
      marker.value = number;

      GEvent.addListener(marker, "click", function() {
        map.openInfoWindowHtml(point, html);
      });
      return marker;
    }

    function createSpeciesName(marker) {
      if (!marker[c.genus] || !marker[c.species]) {
        return "";
      }

      return jQuery.trim(marker[c.genus]) + " " + jQuery.trim(marker[c.species]);
    }

    function addTerritoryBoundaries() {
      // Place a polygon around the area we're most interested in.
      var polygon = new GPolygon([
            new GLatLng(40, -109.5),
            new GLatLng(53, -109.5),
            new GLatLng(53, -126),
            new GLatLng(40, -126),
            new GLatLng(40, -109.5)
		  ], "#0099ff", 2, 1, "#ccffff", 0.2);
		  map.addOverlay(polygon);
		}

    function populateMapBySpecies(species) {
      mgr.clearMarkers();
      var species_markers = [];

      for (var i = 0; i < markers.length; i++) {
        var species_name = createSpeciesName(markers[i]);

        // If a species filter is set, don't display any species other than 
        // the requested.
        if (species != species_name) {
          continue;
        }

        // Apply filters.
        var filters_match = true;
        for (key in filters) {
          var startkey = filters[key][0];
          var endkey = filters[key][1];
          var value = markers[i][c[key]];
          if (value < startkey || value >= endkey) {
            filters_match = false;
            break;
          }
        }

        if (!filters_match) {
          continue;
        }

        // Create a new point for the marker and use any existing information
        // to build a description for the information window.
        var point = new GLatLng(parseFloat(markers[i][c.lat]),
                                parseFloat(markers[i][c.lng]));
        var description = "<table><tr><th colspan='2'>" + species_name + "</th></tr>";
        description += "<tr><td>City/Site:</td><td>" + markers[i][c.city] + "</td></tr>";
        description += "<tr><td>County:</td><td>" + markers[i][c.county] + "</td></tr>";
        description += "<tr><td>State:</td><td>" + markers[i][c.state] + "</td></tr>";
        description += "<tr><td>Year:</td><td>" + markers[i][c.year] + "</td></tr>";
        description += "<tr><td>Elevation:</td><td>" + markers[i][c.elevation] + " " + markers[i][c.elevation_units] + "</td></tr>";
        description += "</table>";
        species_markers.push(createMarker(point, i, description));
      }

      mgr.addMarkers(species_markers, 3, 10);
      mgr.refresh();

      return false;
    }

    function castStringToInt(value) {
      if (value && value.length > 0) {
        return parseInt(value);
      }
      
      return "";
    }

    function load() {
      if (!GBrowserIsCompatible()) {
        return;
      }

      map = new GMap2(document.getElementById("map"));

      // Center on Washington State.
      map.setCenter(new GLatLng(46.90, -118.00), 5);
      map.addControl(new GLargeMapControl());
      map.addControl(new GMapTypeControl());
      map.addMapType(G_PHYSICAL_MAP);
      map.setMapType(G_PHYSICAL_MAP);
      addTerritoryBoundaries();

      // Setup manager to control the zoom levels at which markers are displayed.
      mgr = new MarkerManager(map);

      GDownloadUrl("moths.csv", function(data, responseCode) {
        markers = jQuery.csv(",", "\"", "\n")(data);
        unique_species = new Array();

        for (var i = 0; i < markers.length; i++) {
          var species_name = createSpeciesName(markers[i]);

          // Add this species to the list of unique species if it hasn't been 
          // counted already.  This is done before filtering to get a complete
          // list even when a filter is applied.
          if (species_name != "" && 
              jQuery.inArray(species_name, unique_species) == -1) {
            unique_species.push(species_name);
          }

          // Cast integer and float fields.
          markers[i][c.elevation] = castStringToInt(markers[i][c.elevation]);
          markers[i][c.year] = castStringToInt(markers[i][c.year]);
        }

        // Display a list of the unique species.
        var species_ul = $("<ul></ul>");
        for (i in unique_species) {
          species_a = $("<a href='#'>" + unique_species[i] + "</a>");
          species_a.click(function () {
                            populateMapBySpecies($(this).text());
                          });
          species_ul.append($("<li></li>").append(species_a));
        }
        $("#species").append(species_ul);

        // Display filters to be applied to the current data set.
        var filters_ul = $("<ul></ul>");
        
        // Add link to clear all filters.
        var filters_ul_a = $("<a href='#'>All values</a>");
        filters_ul_a.click(function () {
                             $("#filters a").removeClass("selected");
                             clearFilters();
                           });
        filters_ul.append($("<li></li>").append(filters_ul_a));

        for (filter_index in all_filters) {
          var filter_set = all_filters[filter_index];
          // Store each filter in a nested list.
          var filters_ul_ul = $("<ul></ul>");
          
          // Add link to remove this specific filter.
          filters_ul_a = $("<a href='#'>All " + filter_index + "s</a>");
          filters_ul_a.attr("key", filter_index);
          filters_ul_a.click(function () {
                               $(this).parent().parent().children("a").removeClass("selected");
                               $(this).addClass("selected");
                               removeFilter($(this).attr("key"));
                             });
          filters_ul_ul.append($("<li></li>").append(filters_ul_a));

          // Add links to set each possible value for this filter.
          for (filter in filter_set) {
            var startkey = filter_set[filter][0];
            var endkey = filter_set[filter][1];
            filters_ul_a = $("<a href='#'>" + startkey + " - " + endkey + " </a>");
            filters_ul_a.attr("key", filter_index);
            filters_ul_a.attr("startkey", startkey);
            filters_ul_a.attr("endkey", endkey);
            filters_ul_a.click(function () {
                                 $(this).parent().parent().children(".selected").removeClass("selected");
                                 $(this).addClass("selected");
                                 setFilter($(this).attr("key"),
                                           $(this).attr("startkey"),
                                           $(this).attr("endkey"));
                               });
            filters_ul_ul.append($("<li></li>").append(filters_ul_a));
          }

          filters_ul.append($("<li>" + filter_index + "</li>").append(filters_ul_ul));
        }
        $("#filters").append(filters_ul);
      });
    }
    //]]>
    </script>
  </head>
  <body onload="load()" onunload="GUnload()">
    <div id="status"><p></p></div>
    <div id="map"></div>
    <div id="species"></div>
    <div id="filters"></div>
  </body>
</html>
